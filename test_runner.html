<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URLIngest Test Runner</title>
    <link rel="stylesheet" href="../styles.css"> <!-- Optional: if styles affect tests -->
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #testResults { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
        .log-pass { color: green; }
        .log-fail { color: red; font-weight: bold; }
        .log-error { color: orange; font-weight: bold; }
        .log-info { color: blue; }
        .log-suite { font-weight: bold; margin-top: 15px; font-size: 1.2em; }
        .log-test { margin-left: 10px; font-weight: bold; }
        .log-detail { margin-left: 20px; }
    </style>
</head>
<body>
    <h1>URLIngest Test Runner</h1>
    <p>Open the browser console to see detailed test outputs and errors.</p>
    <p>This page runs unit tests for <code>script.js</code> and functional tests for <code>Research.html</code> logic.</p>
    
    <div id="testResults">
        <p>Test results will also be summarized here (see console for full details).</p>
    </div>

    <!-- Main application script (needed for Research.html tests) -->
    <script src="../script.js"></script>

    <!-- Test Utilities -->
    <script src="tests/test_utils.js"></script>
    
    <!-- Unit Tests -->
    <script src="tests/script_tests.js"></script>
    
    <!-- Functional Tests for Research.html logic (includes its own DOM setup) -->
    <!-- The script from Research.html itself is not directly included here.
         Instead, research_html_tests.js will set up a mock DOM
         and directly call/test the relevant JavaScript functions that would normally be
         in Research.html's inline script. This is a common approach for testing
         inline scripts without loading the entire HTML page in a complex way.
         The functions from Research.html are assumed to be accessible globally or
         through a test harness if they were modularized. For this project, they are global.
    -->
    <script>
        // --- Global variables from Research.html that its functions would expect ---
        // These are declared here so research_html_tests.js can access and manipulate them
        // as if they were in the global scope of Research.html.
        // Actual DOM elements will be created by setupResearchPageDOM() in research_html_tests.js
        
        // DOM Elements (will be assigned in setupResearchPageDOM)
        let topicSelect, fetchPapersButton, paperSelectionSection, paperList, summarizeButton, resultsSection, summariesContainer, tokenCountContainer, searchInput, searchPapersButton, paginationControls, abstractPopup, selectAllButton;
        
        // State Variables (will be reset in setupResearchPageDOM)
        let selectedPapers = [];
        let activeMode = 'summary';
        let isProMode = false;
        let currentPage = 1;
        let resultsPerPage = 25; 
        let currentQuery = '';
        let currentTopic = '';
        let currentFetchMode = 'topic';
        let abstractCache = {};

        // Functions from Research.html (stubs, will be fully defined or tested as part of research_html_tests.js)
        // These are the functions that are part of the inline script in Research.html.
        // The tests in research_html_tests.js will effectively *be* these functions,
        // or will call versions of them defined within the test file for controlled testing.
        // For this setup, research_html_tests.js will define them or use them directly.
        async function getPaperHeadings(topic, skipCount) { /* Mocked or tested in research_html_tests.js */ }
        async function searchArxivPapers(query, startOffset, rpp) { /* Mocked or tested in research_html_tests.js */ }
        function displayPaperHeadings(headings) { /* Mocked or tested in research_html_tests.js */ }
        async function loadPaperData() { /* Tested in research_html_tests.js */ }
        function renderPaginationControls(numResults, rpp) { /* Tested in research_html_tests.js */ }
        function changePage(newPage) { /* Tested in research_html_tests.js */ }
        async function handlePaperMouseEnter(event) { /* Tested in research_html_tests.js */ }
        function handlePaperMouseLeave(event) { /* Tested in research_html_tests.js */ }
        function showAbstractPopup(event) { /* Tested in research_html_tests.js */ }
        // Note: getLLMSummary, getCombinedPaperContent, etc. are not explicitly part of this subtask's tests,
        // but their callers (like summarizeButton click) could be tested if needed.
        
        // The actual functions from Research.html's script are NOT loaded here.
        // research_html_tests.js redefines or directly tests the logic that would be in Research.html.
        // This is because Research.html's script is inline and tightly coupled to its DOM.
        // The setupResearchPageDOM() in research_html_tests.js creates the necessary DOM.
    </script>
    <script src="tests/research_html_tests.js"></script>

    <script>
        // Simple console log interception to display on page (optional enhancement)
        // This is a very basic version.
        const testResultsDiv = document.getElementById('testResults');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function appendLog(message, type) {
            const p = document.createElement('p');
            p.textContent = message;
            if (type === 'error') p.className = 'log-fail'; // Use log-fail for console.error
            else if (type === 'warn') p.className = 'log-error'; // Use log-error for console.warn
            else if (message.startsWith('PASS:')) p.className = 'log-pass';
            else if (message.startsWith('FAIL:')) p.className = 'log-fail';
            else if (message.startsWith('Running test suite:')) p.className = 'log-suite';
            else if (message.startsWith('--- Running test:')) p.className = 'log-test';
            else p.className = 'log-detail';
            testResultsDiv.appendChild(p);
        }

        console.log = function(message) {
            originalConsoleLog.apply(console, arguments);
            appendLog(message, 'log');
        };
        console.error = function(message) {
            originalConsoleError.apply(console, arguments);
            appendLog(message, 'error');
        };
         console.warn = function(message) {
            originalConsoleWarn.apply(console, arguments);
            appendLog(message, 'warn');
        };

        // Clear initial "Test results will also be summarized here"
        testResultsDiv.innerHTML = ''; 
        
        // Announce completion in HTML as well
        document.addEventListener('DOMContentLoaded', () => {
             const completionMessage = document.createElement('p');
             completionMessage.textContent = 'All test suites have been initiated. Check console and above for results.';
             completionMessage.className = 'log-info';
             testResultsDiv.appendChild(completionMessage);
        });
    </script>

</body>
</html>
